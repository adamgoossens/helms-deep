- hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - import_tasks: tasks/k8s-auth.yaml
      vars:
        host: "{{ lookup('env', 'OPENSHIFT_API_URL') }}"
        validate_certs: "{{ not (lookup('env', 'OPENSHIFT_API_INSECURE_CERTS') | bool) }}"
        username: "{{ lookup('env', 'OPENSHIFT_API_USERNAME') }}"
        password: "{{ lookup('env', 'OPENSHIFT_API_PASSWORD') }}"
      tags:
      - k8s

    #######################
    # Start main block
    #######################
    - module_defaults:
        community.kubernetes.k8s_info:
          kubeconfig: "{{ kubeconfig.path }}"
        community.kubernetes.k8s:
          kubeconfig: "{{ kubeconfig.path }}"
        community.kubernetes.helm:
          kubeconfig: "{{ kubeconfig.path }}"
      block:
      - name: get cluster DNS
        community.kubernetes.k8s_info:
          api_version: config.openshift.io/v1
          kind: DNS
          namespace: openshift-config
          name: cluster
        register: cluster_dns

      - set_fact:
          cluster_basedomain: "{{ (cluster_dns.resources|first).spec.baseDomain }}"

      - name: apply kubernetes resources - pre-deployment
        community.kubernetes.k8s:
          merge_type: 'merge'
          definition: "{{ lookup('file', item) | from_yaml }}"
        tags:
          - early-resources
        with_fileglob:
          - "bootstrap-templates/pre-deploy-*.yaml"

      #####
      # Rollout OLM
      #####
      - include_tasks: "{{ item }}"
        loop: "{{ query('fileglob','tasks/bootstrap/*.yaml') | sort }}"

      #####
      # Start MCH rollout now; it takes some time.
      #
      # ACM will roll out the rest of the resources.
      #####
#      - tags:
#        - acm
#        import_tasks: tasks/bootstrap/bootstrap-acm.yaml
#
#      ####
#      # Start ACS rollout now.
#      ####
#      - tags:
#        - acs
#        import_tasks: tasks/bootstrap/bootstrap-acs.yaml
