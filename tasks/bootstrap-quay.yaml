---
- name: quay - deploy Noobaa
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'bootstrap-templates/noobaa.yaml') | from_yaml }}"

- name: quay - wait for Noobaa to rollout (5 minutes)
  community.kubernetes.k8s_info:
    api_version: noobaa.io/v1alpha1
    kind: NooBaa
    namespace: openshift-storage
    name: noobaa
  register: noobaa
  until:
    - noobaa.resources[0].status is defined
    - noobaa.resources[0].status.phase | lower == 'ready'
  delay: 15
  retries: 20

- name: quay - deploy Noobaa Backing Store
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'bootstrap-templates/noobaa-backing-store.yaml') | from_yaml }}"

- name: quay - patch backing store
  community.kubernetes.k8s:
    definition:
      apiVersion: noobaa.io/v1alpha1
      kind: BucketClass
      metadata:
        name: noobaa-default-bucket-class
        namespace: openshift-storage
      spec:
        placementPolicy:
          tiers:
            - backingStores:
              - noobaa-pv-backing-store

- name: quay - create QuayRegistry resources
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'bootstrap-templates/quayregistry.yaml.j2') | from_yaml }}"
  vars:
    namespace: "helms-deep-registry-prod"

- name: quay - wait for QuayRegistry rollout (20 mins)
  community.kubernetes.k8s_info:
    kind: QuayRegistry
    namespace: helms-deep-registry-prod
    name: registry
  register: quayreg
  vars:
    query: "conditions[?type=='Available' && status=='True']"
  until:
    - quayreg.resources[0].status is defined
    - quayreg.resources[0].status | json_query(query) | length > 0
  delay: 30
  retries: 40

- name: quay - get route
  community.kubernetes.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: registry-quay
    namespace: helms-deep-registry-prod
  register: quayroute

- set_fact:
    quay_outputs:
      quay_route: "https://{{ quayroute.resources[0].spec.host }}"
